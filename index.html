<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalfNote å­ç‰›ç®¡ç†</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d; --danger-color: #dc3545;
            --light-gray: #f0f2f5; --text-color: #333; --white-color: #fff;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0 0 80px 0; background-color: var(--light-gray); color: var(--text-color); }
        .page { display: none; padding: 15px; }
        .page.active { display: block; }
        h1, h2, h3 { margin: 0; padding: 0; }
        h1 { font-size: 1.4em; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
        h2 { font-size: 1.2em; margin: 20px 0 15px 0; border-bottom: 2px solid var(--primary-color); }
        h3 { font-size: 1.1em; margin: 20px 0 10px 0; border-left: 4px solid var(--primary-color); padding-left: 8px; }
        .card { background-color: var(--white-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .button { display: block; width: 100%; padding: 12px; background-color: var(--primary-color); color: var(--white-color); border: none; border-radius: 8px; font-size: 1.1em; text-align: center; cursor: pointer; margin-top: 15px; }
        .button-secondary { background-color: var(--secondary-color); }
        .button-danger { background-color: var(--danger-color); }
        .button-small { display: inline-block; width: auto; padding: 8px 12px; font-size: 0.9em; margin-left: 5px; }
        .button-group { display: flex; gap: 10px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background-color: var(--white-color); display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: #888; flex: 1; text-align: center; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item-icon { font-size: 24px; display: flex; align-items: center; justify-content: center; height: 28px; }
        .nav-item-text { font-size: 12px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .radio-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .radio-group label { flex: 1; min-width: 50px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; text-align: center; cursor: pointer; }
        .radio-group input[type="radio"] { display: none; }
        .radio-group input[type="radio"]:checked + label { background-color: var(--primary-color); color: var(--white-color); border-color: var(--primary-color); }
        .item-list { list-style: none; padding: 0; margin: 0; }
        .list-item { background-color: var(--white-color); padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .list-item.clickable { cursor: pointer; }
        .list-item.clickable:hover { background-color: #f8f9fa; }
        .list-item:first-child { border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .list-item:last-child { border-bottom: none; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
        #sale-schedule-list .list-item {background-color: transparent; padding: 10px 15px;}
        #sale-schedule-list h3 {margin: 15px 0 5px; padding-bottom: 5px; border-bottom: 1px solid #ddd;}
        .modal { position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background-color: var(--white-color); padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        .data-table th, .data-table td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        .data-table th { font-size: 0.9em; background-color: #f8f9fa; }
        .data-table td select, .data-table td input[type="number"], .data-table td input[type="text"] { padding: 4px; font-size: 0.9em; max-width: 120px; }
        .data-table .cow-name { cursor: pointer; color: var(--primary-color); font-weight: bold; }
        .data-table input[type="checkbox"] { width: 20px; height: 20px; }
        .rotate-header { writing-mode: vertical-rl; text-orientation: mixed; white-space: nowrap; padding: 10px 4px; }
        .logo { font-family: 'Helvetica Neue', Arial, sans-serif; font-weight: 300; font-size: 2em; text-align: left; }
        .logo-calf { font-weight: 700; color: #333; }
        .logo-note { color: var(--primary-color); }
        .memo-text { font-size: 0.9em; color: #666; white-space: pre-wrap; margin-top: 5px; background-color: #f8f9fa; padding: 8px; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="page-dashboard" class="page active">
        <h1 class="logo"><span class="logo-calf">Calf</span><span class="logo-note">Note</span></h1>
        <div class="card"><h2>ã€ï¼ã€‘ToDoãƒªã‚¹ãƒˆ</h2><ul id="todo-list" class="item-list"></ul></div>
        <div class="card"><h2>ã‚»ãƒªäºˆå®š</h2><ul id="sale-schedule-list" class="item-list"></ul></div>
        <div class="card"><h2>ç‰›ç¾¤ã‚µãƒãƒªãƒ¼</h2><p id="summary-text"></p></div>
        <button type="button" class="button" onclick="showPage('new-cow')" style="margin-top: 20px;">ï¼‹ æ–°ã—ã„å­ç‰›ã‚’ç™»éŒ²</button>
    </div>

    <div id="page-cow-list" class="page">
        <h1 id="cow-list-title">ç‰›ä¸€è¦§ï¼ˆé£¼è‚²ä¸­ï¼‰</h1>
        <ul id="cow-list-items" class="item-list"></ul>
        <button id="show-shipped-cows-button" class="button button-secondary">å‡ºè·æ¸ˆã¿ç‰›ä¸€è¦§ã‚’è¦‹ã‚‹</button>
    </div>

    <div id="page-shipped-list" class="page">
        <h1>å‡ºè·æ¸ˆã¿ç‰›ä¸€è¦§</h1>
        <ul id="shipped-list-items" class="item-list"></ul>
        <button class="button button-secondary" onclick="showPage('cow-list')">é£¼è‚²ä¸­ä¸€è¦§ã«æˆ»ã‚‹</button>
    </div>

    <div id="page-health-management" class="page">
        <h1 id="health-management-title">å¥åº·ç®¡ç†ä¸€è¦§</h1>
        <div class="card">
            <div class="form-group"><label for="sort-health-list">ä¸¦ã³æ›¿ãˆ</label><select id="sort-health-list"><option value="birthDate_desc">æœˆé½¢ã®é«˜ã„é †</option><option value="birthDate_asc">æœˆé½¢ã®ä½ã„é †</option><option value="name_asc">åå‰é †</option><option value="status_asc">çŠ¶æ…‹é †</option></select></div>
            <div class="table-container"><table class="data-table"><thead><tr><th>åå‰ (ä¸‹5æ¡)</th><th>çŠ¶æ…‹</th><th>ç—‡çŠ¶</th><th>ä½“æ¸©</th><th>ãƒ¡ãƒ¢ (ä»»æ„)</th></tr></thead><tbody id="health-list-body"></tbody></table></div>
            <button id="save-health-changes" class="button">æœ¬æ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹</button>
        </div>
    </div>
    
    <div id="page-vaccine-management" class="page">
        <h1>ãƒ¯ã‚¯ãƒãƒ³ç®¡ç†</h1>
        <div class="card">
            <div id="vaccine-pending-container">
                <h3>æ¥ç¨®ãŒå¿…è¦ãªç‰›</h3>
                <div class="table-container"><table id="vaccine-matrix-table-pending" class="data-table"></table></div>
            </div>
            <button id="save-vaccine-changes" class="button">å¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹</button>
        </div>
        <div class="card" id="vaccine-completed-card">
            <div id="vaccine-completed-container" style="margin-top: 20px;">
                <h3>ãƒ¯ã‚¯ãƒãƒ³å®Œäº†æ¸ˆã¿ã®ç‰›</h3>
                <div class="table-container"><table id="vaccine-matrix-table-completed" class="data-table"></table></div>
            </div>
        </div>
    </div>

    <div id="page-cow-detail" class="page">
        <h1 id="detail-cow-name"></h1>
        <div class="card">
            <h2>åŸºæœ¬æƒ…å ± <button id="edit-cow-button" class="button-small">ç·¨é›†</button></h2>
            <p><strong>å€‹ä½“è­˜åˆ¥ç•ªå·:</strong> <span id="view-cow-id"></span></p>
            <p><strong>æ¯ç‰›ç•ªå·:</strong> <span id="view-mother-id"></span></p>
            <p><strong>çˆ¶ã®ç¨®é›„ç‰›:</strong> <span id="view-father-id"></span></p>
            <p><strong>æ¯ã®çˆ¶ã®ç¨®é›„ç‰›:</strong> <span id="view-bms-id"></span></p>
            <p><strong>ç”Ÿå¹´æœˆæ—¥:</strong> <span id="view-birth-date"></span> (<span id="view-days-old"></span>æ—¥é½¢)</p>
            <p><strong>æ€§åˆ¥:</strong> <span id="view-gender"></span></p>
            <p id="view-birth-size-container"><strong>å‡ºç”Ÿæ™‚ã‚µã‚¤ã‚º:</strong> <span id="view-birth-size"></span></p>
            <p id="view-birth-memo-container"><strong>å‡ºç”Ÿæ™‚ãƒ¡ãƒ¢:</strong> <span id="view-birth-memo" class="memo-text"></span></p>
            <p id="view-castration-status-container"><strong>å»å‹¢:</strong> <span id="view-castration-status"></span></p>
            <div class="form-group" id="sale-month-container" style="margin-top: 15px;">
                <label for="sale-month-select" style="font-weight: bold;">ã‚»ãƒªäºˆå®šæœˆ:</label>
                <div class="button-group">
                    <select id="sale-month-select" style="flex-grow: 1;"></select>
                    <button id="save-sale-month-button" class="button-small">ä¿å­˜</button>
                </div>
            </div>
        </div>
        <div class="card" id="sale-info-view" style="display:none;">
            <h2>å‡ºè·æƒ…å ±</h2>
            <p><strong>å‡ºè·æ—¥é½¢:</strong> <span id="view-sale-days"></span> æ—¥</p><p><strong>å‡ºè·ä½“é‡:</strong> <span id="view-sale-weight"></span> kg</p><p><strong>è²©å£²ä¾¡æ ¼:</strong> <span id="view-sale-price"></span> åƒå††</p><p><strong>è³¼è²·è€…:</strong> <span id="view-buyer-name"></span></p>
        </div>
        <div class="card" id="detail-actions-card">
            <button class="button button-secondary" id="open-sale-modal-button">å‡ºè·æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹</button>
            <button class="button button-danger" id="delete-cow-button">ã“ã®ç‰›ã®æƒ…å ±ã‚’å‰Šé™¤ã™ã‚‹</button>
        </div>
        <div class="card"><h3>å¥åº·è¨˜éŒ²</h3><ul id="detail-health-records" class="item-list"></ul></div>
        <div class="card"><h3>ãƒ¯ã‚¯ãƒãƒ³å±¥æ­´</h3><ul id="detail-vaccine-events" class="item-list"></ul></div>
        <button class="button button-secondary" onclick="history.back()">æˆ»ã‚‹</button>
    </div>

    <div id="page-new-cow" class="page">
        <h1>å­ç‰›ã®æ–°è¦ç™»éŒ²</h1>
        <form id="new-cow-form" class="card">
            <div class="form-group"><label for="cow-id">å€‹ä½“è­˜åˆ¥ç•ªå· (10æ¡, æœªå®šã¯ç©ºæ¬„)</label><input type="text" id="cow-id" pattern="[0-9]{10}"></div>
            <div class="form-group"><label for="mother-id">æ¯ç‰›ç•ªå·</label><input type="text" id="mother-id"></div>
            <div class="form-group"><label for="father-id">çˆ¶ã®ç¨®é›„ç‰› (ä»»æ„)</label><input type="text" id="father-id"></div>
            <div class="form-group"><label for="bms-id">æ¯ã®çˆ¶ã®ç¨®é›„ç‰› (ä»»æ„)</label><input type="text" id="bms-id"></div>
            <div class="form-group"><label for="birth-date">ç”Ÿå¹´æœˆæ—¥</label><input type="date" id="birth-date" required></div>
            <div class="form-group"><label>æ€§åˆ¥</label><div class="radio-group"><input type="radio" name="gender" id="gender-male" value="ã‚ªã‚¹" checked><label for="gender-male">ã‚ªã‚¹</label><input type="radio" name="gender" id="gender-female" value="ãƒ¡ã‚¹"><label for="gender-female">ãƒ¡ã‚¹</label></div></div>
            <div class="form-group"><label>å‡ºç”Ÿæ™‚ã‚µã‚¤ã‚º (ä»»æ„)</label><div class="radio-group"><input type="radio" name="birth-size" id="size-1" value="1"><label for="size-1">1</label><input type="radio" name="birth-size" id="size-2" value="2"><label for="size-2">2</label><input type="radio" name="birth-size" id="size-3" value="3" checked><label for="size-3">3</label><input type="radio" name="birth-size" id="size-4" value="4"><label for="size-4">4</label><input type="radio" name="birth-size" id="size-5" value="5"><label for="size-5">5</label></div></div>
            <div class="form-group"><label for="birth-memo">å‡ºç”Ÿæ™‚ãƒ¡ãƒ¢ (ä»»æ„)</label><textarea id="birth-memo" rows="3"></textarea></div>
            <button type="submit" class="button">ç™»éŒ²</button><button type="button" class="button button-secondary" onclick="showPage('dashboard')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </form>
    </div>

    <div id="page-settings" class="page">
        <h1>è¨­å®š</h1>
        <div class="card">
            <h2>ãƒ¯ã‚¯ãƒãƒ³è¨­å®š</h2><div id="vaccine-settings-list"></div>
            <form id="add-vaccine-type-form">
                <h3>æ–°ã—ã„ãƒ¯ã‚¯ãƒãƒ³ã‚’è¿½åŠ </h3>
                <div class="form-group"><label>ãƒ¯ã‚¯ãƒãƒ³å</label><input type="text" id="new-vaccine-name" required></div>
                <div class="form-group"><label>æ¨å¥¨æ—¥é½¢ (é–‹å§‹)</label><input type="number" id="new-vaccine-min-days" placeholder="ä¾‹: 14" required></div>
                <div class="form-group"><label>æ¨å¥¨æ—¥é½¢ (çµ‚äº†)</label><input type="number" id="new-vaccine-max-days" placeholder="ä¾‹: 21" required></div>
                <button type="submit" class="button-small">è¿½åŠ </button>
            </form>
        </div>
        <div class="card">
            <h2>å»å‹¢è¨­å®š</h2><div class="form-group"><label for="castration-days">å»å‹¢ã®æ¨å¥¨æ—¥é½¢</label><input type="number" id="castration-days"></div>
            <button id="save-settings-button" class="button">è¨­å®šã‚’ä¿å­˜</button>
        </div>
        <div class="card">
            <h2>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2><button id="export-data" class="button">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <div class="form-group" style="margin-top: 15px;"><label for="import-data-file">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</label><input type="file" id="import-data-file" accept=".json"></div>
        </div>
    </div>
    
    <div id="sale-info-modal" class="modal">
        <div class="modal-content">
            <h2>å‡ºè·æƒ…å ±ã®ç™»éŒ²</h2>
            <form id="sale-info-form">
                <div class="form-group"><label for="sale-days-old">å‡ºè·æ—¥é½¢ (æ—¥)</label><input type="number" id="sale-days-old" required></div>
                <div class="form-group"><label for="sale-weight">å‡ºè·ä½“é‡ (kg)</label><input type="number" id="sale-weight" required></div>
                <div class="form-group"><label for="sale-price">è²©å£²ä¾¡æ ¼ (åƒå††)</label><input type="number" id="sale-price" placeholder="ä¾‹: 850" required></div>
                <div class="form-group"><label for="buyer-name">è³¼è²·è€…å</label><input type="text" id="buyer-name"></div>
                <div class="button-group"><button type="submit" class="button">ç™»éŒ²ã—ã¦å‡ºè·æ¸ˆã«ã™ã‚‹</button><button type="button" id="close-sale-modal-button" class="button button-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div>
            </form>
        </div>
    </div>
    
    <div id="edit-cow-modal" class="modal">
        <div class="modal-content">
            <h2>åŸºæœ¬æƒ…å ±ã®ç·¨é›†</h2>
            <form id="edit-cow-form">
                <div class="form-group"><label for="edit-cow-id">å€‹ä½“è­˜åˆ¥ç•ªå·</label><input type="text" id="edit-cow-id" pattern="[0-9]{10}"></div>
                <div class="form-group"><label for="edit-mother-id">æ¯ç‰›ç•ªå·</label><input type="text" id="edit-mother-id"></div>
                <div class="form-group"><label for="edit-father-id">çˆ¶ã®ç¨®é›„ç‰›</label><input type="text" id="edit-father-id"></div>
                <div class="form-group"><label for="edit-bms-id">æ¯ã®çˆ¶ã®ç¨®é›„ç‰›</label><input type="text" id="edit-bms-id"></div>
                <div class="form-group"><label for="edit-birth-date">ç”Ÿå¹´æœˆæ—¥</label><input type="date" id="edit-birth-date" required></div>
                <div class="form-group"><label>æ€§åˆ¥</label><div class="radio-group"><input type="radio" name="edit-gender" id="edit-gender-male" value="ã‚ªã‚¹"><label for="edit-gender-male">ã‚ªã‚¹</label><input type="radio" name="edit-gender" id="edit-gender-female" value="ãƒ¡ã‚¹"><label for="edit-gender-female">ãƒ¡ã‚¹</label></div></div>
                <div class="form-group"><label>å‡ºç”Ÿæ™‚ã‚µã‚¤ã‚º</label><div class="radio-group" id="edit-birth-size-group"></div></div>
                <div class="form-group"><label for="edit-birth-memo">å‡ºç”Ÿæ™‚ãƒ¡ãƒ¢</label><textarea id="edit-birth-memo" rows="3"></textarea></div>
                <div class="button-group">
                    <button type="submit" class="button">ä¿å­˜</button>
                    <button type="button" id="close-edit-modal-button" class="button button-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </form>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" data-page="dashboard"><span class="nav-item-icon">ğŸ </span><span class="nav-item-text">ãƒãƒ¼ãƒˆ</span></div>
        <div class="nav-item" data-page="cow-list"><span class="nav-item-icon">ğŸ„</span><span class="nav-item-text">ç‰›ä¸€è¦§</span></div>
        <div class="nav-item" data-page="health-management"><span class="nav-item-icon">ğŸ©º</span><span class="nav-item-text">å¥åº·ç®¡ç†</span></div><div class="nav-item" data-page="vaccine-management"><span class="nav-item-icon">ğŸ’‰</span><span class="nav-item-text">ãƒ¯ã‚¯ãƒãƒ³</span></div><div class="nav-item" data-page="settings"><span class="nav-item-icon">âš™ï¸</span><span class="nav-item-text">è¨­å®š</span></div>
    </div>

<script>
let state = {cows: [], healthRecords: [], vaccineEvents: [], vaccineTypes: [], settings: { castrationDays: 90 }, activePage: 'dashboard', currentCowId: null,};
let vaccineMatrixChanges = {};
let healthMatrixChanges = {};

document.addEventListener('DOMContentLoaded', () => {
    loadData();
    if (state.vaccineTypes.length === 0) {
        state.vaccineTypes.push( { id: 'vt_1', name: 'ï¾Šï¾ï½²ï½ºï½¯ï½¸ï½½', minDays: 14, maxDays: 21 }, { id: 'vt_2', name: 'RS-PI3', minDays: 30, maxDays: 60 }, { id: 'vt_3', name: 'ï½±ï½²ï¾ï¾ï¾’ï½¯ï½¸', minDays: 90, maxDays: 120 });
    }
    setupEventListeners();
    showPage('dashboard');
});

function saveData() { localStorage.setItem('ushikanri_data_v5.1', JSON.stringify(state)); }
function loadData() {
    const data = localStorage.getItem('ushikanri_data_v5.1') || localStorage.getItem('ushikanri_data_v5.0') || localStorage.getItem('ushikanri_data_v4.9');
    if (data) {
        const loadedState = JSON.parse(data);
        Object.assign(state, loadedState);
        if(!state.settings) state.settings = { castrationDays: 90 };
        // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        state.cows.forEach(cow => {
            if (cow.bmsId === undefined) cow.bmsId = '';
            if (cow.saleMonth === undefined) cow.saleMonth = null;
            if (cow.birthSize === undefined) cow.birthSize = '3';
            if (cow.birthMemo === undefined) cow.birthMemo = '';
        });
        state.healthRecords.forEach(rec => {
            if (rec.memo === undefined) rec.memo = '';
        });
    }
}
const formatDate = (ds) => ds ? new Date(ds).toLocaleDateString('ja-JP') : 'N/A';
const getDaysOld = (bd) => bd ? Math.floor((new Date() - new Date(bd)) / (1000 * 60 * 60 * 24)) : 0;
const createId = () => 'id_' + Date.now() + Math.random().toString(36).substr(2, 9);
const getActiveCows = () => state.cows.filter(c => c.status === 'é£¼è‚²ä¸­');
const getShippedCows = () => state.cows.filter(c => c.status === 'å‡ºè·æ¸ˆ');
const getCowHealthStatusObject = (cowId) => {
    const lastRecord = state.healthRecords.filter(r => r.cowId === cowId).sort((a,b) => new Date(b.date) - new Date(a.date))[0];
    if (lastRecord) return { ...lastRecord };
    return { status: 'å¥åº·', symptom: 'ãªã—', temperature: '', memo: '' };
};
const getCowDisplayName = (cow) => { if (cow.cowId && cow.cowId.length >= 5) { return cow.cowId.slice(-5); } return cow.name; };
const getEligibleCowsForVaccine = (vaccineType) => {
    if (!vaccineType.minDays || !vaccineType.maxDays) return [];
    return getActiveCows().filter(cow => {
        const daysOld = getDaysOld(cow.birthDate);
        const hasTaken = state.vaccineEvents.some(ve => ve.cowId === cow.id && ve.vaccineTypeId === vaccineType.id);
        return !hasTaken && daysOld >= vaccineType.minDays && daysOld <= vaccineType.maxDays;
    });
};

function showPage(pageId, options = {}) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(`page-${pageId}`).classList.add('active');
    document.querySelectorAll('.nav-item[data-page]').forEach(item => item.classList.remove('active'));
    const navItem = document.querySelector(`.nav-item[data-page="${pageId}"]`);
    if(navItem) navItem.classList.add('active');
    state.activePage = pageId; state.currentCowId = options.cowId || null;
    window.scrollTo(0, 0);
    const renderMap = {
        'dashboard': renderDashboard, 'cow-list': () => renderCowList(options.filter), 'shipped-list': renderShippedList,
        'health-management': () => renderHealthManagementList(options.filter), 'vaccine-management': renderVaccineMatrix,
        'settings': renderSettingsPage, 'cow-detail': () => renderCowDetail(options.cowId),
        'new-cow': () => { document.getElementById('new-cow-form').reset(); document.getElementById('birth-date').valueAsDate = new Date(); },
    };
    if (pageId === 'vaccine-management') initializeVaccineMatrixChanges();
    if (pageId === 'health-management') initializeHealthMatrixChanges(options.filter);
    if (renderMap[pageId]) renderMap[pageId]();
}

function setupEventListeners() {
    document.querySelectorAll('.nav-item[data-page]').forEach(item => { item.addEventListener('click', (e) => showPage(e.currentTarget.dataset.page)); });
    document.getElementById('show-shipped-cows-button').addEventListener('click', () => showPage('shipped-list'));
    document.getElementById('new-cow-form').addEventListener('submit', handleNewCowSubmit);
    document.getElementById('add-vaccine-type-form').addEventListener('submit', handleAddVaccineType);
    document.getElementById('save-settings-button').addEventListener('click', handleSaveSettings);
    document.getElementById('sort-health-list').addEventListener('change', () => renderHealthManagementList());
    document.getElementById('health-list-body').addEventListener('change', handleHealthListChange);
    document.getElementById('save-health-changes').addEventListener('click', handleSaveHealthChanges);
    document.getElementById('page-vaccine-management').addEventListener('change', handleVaccineMatrixChange);
    document.getElementById('save-vaccine-changes').addEventListener('click', handleSaveVaccineChanges);
    document.getElementById('sale-info-form').addEventListener('submit', handleSaleInfoSubmit);
    document.getElementById('open-sale-modal-button').addEventListener('click', () => {
        const cow = state.cows.find(c => c.id === state.currentCowId);
        if(cow) document.getElementById('sale-days-old').value = getDaysOld(cow.birthDate);
        document.getElementById('sale-info-modal').style.display = 'flex';
    });
    document.getElementById('close-sale-modal-button').addEventListener('click', () => { document.getElementById('sale-info-modal').style.display = 'none'; document.getElementById('sale-info-form').reset(); });
    document.getElementById('export-data').addEventListener('click', exportData);
    document.getElementById('import-data-file').addEventListener('change', importData);
    document.getElementById('delete-cow-button').addEventListener('click', handleDeleteCow);
    document.getElementById('edit-cow-button').addEventListener('click', () => openEditModal(state.currentCowId));
    document.getElementById('edit-cow-form').addEventListener('submit', handleEditCowSubmit);
    document.getElementById('close-edit-modal-button').addEventListener('click', () => { document.getElementById('edit-cow-modal').style.display = 'none'; });
    document.getElementById('save-sale-month-button').addEventListener('click', saveSaleMonth);
}

function handleNewCowSubmit(e) {
    e.preventDefault();
    const cowIdVal = document.getElementById('cow-id').value.trim();
    const motherId = document.getElementById('mother-id').value.trim();
    const birthDate = document.getElementById('birth-date').value;
    
    if (!cowIdVal && !motherId) { alert('å€‹ä½“è­˜åˆ¥ç•ªå·ã‹æ¯ç‰›ç•ªå·ã®ã©ã¡ã‚‰ã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
    if (!birthDate) { alert('ç”Ÿå¹´æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }

    const gender = document.querySelector('input[name="gender"]:checked').value;
    const birthSizeRadio = document.querySelector('input[name="birth-size"]:checked');

    const newCow = {
        id: createId(),
        cowId: cowIdVal || null,
        motherId: motherId,
        fatherId: document.getElementById('father-id').value.trim(),
        bmsId: document.getElementById('bms-id').value.trim(),
        birthDate: birthDate,
        gender: gender,
        status: 'é£¼è‚²ä¸­',
        castrationStatus: gender === 'ã‚ªã‚¹' ? 'æœªå‡¦ç†' : 'å¯¾è±¡å¤–',
        saleInfo: null,
        saleMonth: null,
        birthSize: birthSizeRadio ? birthSizeRadio.value : '3',
        birthMemo: document.getElementById('birth-memo').value.trim(),
        name: cowIdVal || `${motherId}ã®å­-${new Date(birthDate).getMonth() + 1}/${new Date(birthDate).getDate()}`
    };
    state.cows.push(newCow);
    saveData();
    alert('ç™»éŒ²ã—ã¾ã—ãŸã€‚');
    e.target.reset();
    showPage('cow-list');
}

function renderDashboard() {
    const todoList = document.getElementById('todo-list');
    todoList.innerHTML = '';
    let todoCount = 0;
    const treatingCows = getActiveCows().filter(cow => getCowHealthStatusObject(cow.id).status === 'æ²»ç™‚ä¸­');
    if (treatingCows.length > 0) { todoList.innerHTML += `<li class="list-item clickable" onclick="showPage('health-management',{filter:'treating'})">ğŸ©º æ²»ç™‚ä¸­ã®ç‰›ãŒ <strong>${treatingCows.length}é ­</strong> ã„ã¾ã™ <span>></span></li>`; todoCount++; }
    const castrationTargetCows = getActiveCows().filter(c => c.gender === 'ã‚ªã‚¹' && c.castrationStatus === 'æœªå‡¦ç†' && getDaysOld(c.birthDate) >= state.settings.castrationDays);
    if (castrationTargetCows.length > 0) { todoList.innerHTML += `<li class="list-item clickable" onclick="showPage('cow-list',{filter:'castration'})">âš ï¸ å»å‹¢æ¨å¥¨æ—¥é½¢ã®ç‰›ãŒ <strong>${castrationTargetCows.length}é ­</strong> ã„ã¾ã™ <span>></span></li>`; todoCount++; }
    state.vaccineTypes.forEach(vt => {
        const eligibleCows = getEligibleCowsForVaccine(vt);
        if (eligibleCows.length > 0) { todoList.innerHTML += `<li class="list-item clickable" onclick="showPage('vaccine-management')">ğŸ’‰ ã€Œ${vt.name}ã€ã®æ¥ç¨®æ™‚æœŸã®ç‰›ãŒ <strong>${eligibleCows.length}é ­</strong> ã„ã¾ã™ <span>></span></li>`; todoCount++; }
    });
    if (todoCount === 0) todoList.innerHTML = '<li class="list-item">ç¾åœ¨ã€ç·Šæ€¥ã®ToDoã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';

    const saleScheduleList = document.getElementById('sale-schedule-list');
    saleScheduleList.innerHTML = '';
    const scheduledCows = getActiveCows().filter(cow => cow.saleMonth && new Date(cow.saleMonth) >= new Date(new Date().getFullYear(), new Date().getMonth())).sort((a, b) => a.saleMonth.localeCompare(b.saleMonth));
    if (scheduledCows.length === 0) { saleScheduleList.innerHTML = '<li class="list-item">ã‚»ãƒªäºˆå®šã®ç‰›ã¯ã„ã¾ã›ã‚“ã€‚</li>'; }
    else { const groupedByMonth = scheduledCows.reduce((acc, cow) => { const month = cow.saleMonth; if (!acc[month]) acc[month] = []; acc[month].push(cow); return acc; }, {}); let html = ''; for (const month in groupedByMonth) { const [year, monthNum] = month.split('-'); html += `<h3>${year}å¹´${parseInt(monthNum, 10)}æœˆ</h3>`; groupedByMonth[month].forEach(cow => { html += `<li class="list-item clickable" onclick="showPage('cow-detail', {cowId: '${cow.id}'})">${getCowDisplayName(cow)}<span>></span></li>`; }); } saleScheduleList.innerHTML = html; }

    const activeCows = getActiveCows();
    const maleCount = activeCows.filter(c => c.gender === 'ã‚ªã‚¹').length;
    const femaleCount = activeCows.filter(c => c.gender === 'ãƒ¡ã‚¹').length;
    document.getElementById('summary-text').textContent = `é£¼è‚²é ­æ•°ï¼š ${activeCows.length}é ­ ï¼ˆã‚ªã‚¹: ${maleCount}, ãƒ¡ã‚¹: ${femaleCount}ï¼‰`;
}

function renderCowDetail(cowId) {
    const cow = state.cows.find(c => c.id === cowId);
    if (!cow) { showPage('cow-list'); return; }

    document.getElementById('detail-cow-name').textContent = cow.name;
    document.getElementById('view-cow-id').textContent = cow.cowId || 'æœªè¨­å®š';
    document.getElementById('view-mother-id').textContent = cow.motherId;
    document.getElementById('view-father-id').textContent = cow.fatherId || 'æœªè¨­å®š';
    document.getElementById('view-bms-id').textContent = cow.bmsId || 'æœªè¨­å®š';
    document.getElementById('view-birth-date').textContent = formatDate(cow.birthDate);
    document.getElementById('view-days-old').textContent = getDaysOld(cow.birthDate);
    document.getElementById('view-gender').textContent = cow.gender;
    
    // å‡ºç”Ÿæ™‚æƒ…å ±
    document.getElementById('view-birth-size').textContent = cow.birthSize ? `${cow.birthSize} / 5` : 'æœªè¨­å®š';
    const birthMemoEl = document.getElementById('view-birth-memo');
    birthMemoEl.textContent = cow.birthMemo || 'ãªã—';
    document.getElementById('view-birth-memo-container').style.display = cow.birthMemo ? 'block' : 'none';

    const saleMonthSelect = document.getElementById('sale-month-select');
    saleMonthSelect.innerHTML = '<option value="">æœªè¨­å®š</option>';
    if (cow.birthDate) {
        const birth = new Date(cow.birthDate);
        let currentDate = new Date(birth.getFullYear(), birth.getMonth(), birth.getDate() + 260);
        const endDate = new Date(birth.getFullYear(), birth.getMonth(), birth.getDate() + 365);
        while (currentDate <= endDate) {
            const year = currentDate.getFullYear();
            const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
            const value = `${year}-${month}`;
            if (!saleMonthSelect.querySelector(`option[value="${value}"]`)) {
                const option = document.createElement('option'); option.value = value; option.textContent = `${year}å¹´${parseInt(month, 10)}æœˆ`; if (cow.saleMonth === value) option.selected = true; saleMonthSelect.appendChild(option);
            }
            currentDate.setMonth(currentDate.getMonth() + 1); currentDate.setDate(1);
        }
    }
    document.getElementById('sale-month-container').style.display = cow.status === 'é£¼è‚²ä¸­' ? 'block' : 'none';
    
    const castrationContainer = document.getElementById('view-castration-status-container');
    if (cow.gender === 'ã‚ªã‚¹') {
        castrationContainer.style.display = 'block';
        let statusHTML = cow.castrationStatus;
        if (cow.status === 'é£¼è‚²ä¸­') {
            if (cow.castrationStatus === 'æœªå‡¦ç†') {
                statusHTML += ` <button class="button-small" onclick="updateCastrationStatus('${cow.id}')">å‡¦ç†æ¸ˆã«ã™ã‚‹</button>`;
            } else if (cow.castrationStatus === 'å‡¦ç†æ¸ˆ') {
                statusHTML += ` <button class="button-small button-secondary" onclick="revertCastrationStatus('${cow.id}')">æœªå‡¦ç†ã«æˆ»ã™</button>`;
            }
        }
        document.getElementById('view-castration-status').innerHTML = statusHTML;
    } else {
        castrationContainer.style.display = 'none';
    }

    const saleInfoView = document.getElementById('sale-info-view');
    const openSaleModalButton = document.getElementById('open-sale-modal-button');
    if (cow.status === 'å‡ºè·æ¸ˆ' && cow.saleInfo) {
        saleInfoView.style.display = 'block';
        document.getElementById('view-sale-days').textContent = cow.saleInfo.daysOld;
        document.getElementById('view-sale-weight').textContent = cow.saleInfo.weight;
        document.getElementById('view-sale-price').textContent = cow.saleInfo.price;
        document.getElementById('view-buyer-name').textContent = cow.saleInfo.buyerName || 'æœªç™»éŒ²';
        openSaleModalButton.style.display = 'none';
    } else {
        saleInfoView.style.display = 'none';
        openSaleModalButton.style.display = 'block';
    }
    
    const healthList = document.getElementById('detail-health-records');
    healthList.innerHTML = '';
    const cowHealthRecords = state.healthRecords.filter(r => r.cowId === cowId).sort((a, b) => new Date(b.date) - new Date(a.date));
    if (cowHealthRecords.length === 0) { healthList.innerHTML = '<li class="list-item">è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>'; }
    else { cowHealthRecords.forEach(rec => { const memoHTML = rec.memo ? `<div class="memo-text">${rec.memo}</div>` : ''; healthList.innerHTML += `<li class="list-item"><div>${formatDate(rec.date)}: ${rec.status} (${rec.symptom}) ${rec.temperature ? rec.temperature + 'â„ƒ' : ''}${memoHTML}</div></li>`; }); }

    const vaccineList = document.getElementById('detail-vaccine-events');
    vaccineList.innerHTML = '';
    const cowVaccineEvents = state.vaccineEvents.filter(ve => ve.cowId === cowId);
    if (cowVaccineEvents.length === 0) { vaccineList.innerHTML = '<li class="list-item">è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>'; }
    else { cowVaccineEvents.forEach(ve => { const vaccineType = state.vaccineTypes.find(vt => vt.id === ve.vaccineTypeId); vaccineList.innerHTML += `<li class="list-item">${vaccineType ? vaccineType.name : 'ä¸æ˜'} (å®Œäº†æ—¥: ${formatDate(ve.date)})</li>`; }); }
}

function openEditModal(cowId) {
    const cow = state.cows.find(c => c.id === cowId);
    if (!cow) return;
    document.getElementById('edit-cow-id').value = cow.cowId || '';
    document.getElementById('edit-mother-id').value = cow.motherId || '';
    document.getElementById('edit-father-id').value = cow.fatherId || '';
    document.getElementById('edit-bms-id').value = cow.bmsId || '';
    document.getElementById('edit-birth-date').value = cow.birthDate;
    if (cow.gender === 'ã‚ªã‚¹') { document.getElementById('edit-gender-male').checked = true; } else { document.getElementById('edit-gender-female').checked = true; }
    
    // å‡ºç”Ÿæ™‚ã‚µã‚¤ã‚ºã¨ãƒ¡ãƒ¢ã®ç·¨é›†
    const sizeGroup = document.getElementById('edit-birth-size-group');
    sizeGroup.innerHTML = '';
    for(let i=1; i<=5; i++) {
        const checked = (cow.birthSize == i) ? 'checked' : '';
        sizeGroup.innerHTML += `<input type="radio" name="edit-birth-size" id="edit-size-${i}" value="${i}" ${checked}><label for="edit-size-${i}">${i}</label>`;
    }
    document.getElementById('edit-birth-memo').value = cow.birthMemo || '';
    
    document.getElementById('edit-cow-modal').style.display = 'flex';
}

function handleEditCowSubmit(e) {
    e.preventDefault();
    const cow = state.cows.find(c => c.id === state.currentCowId);
    if (!cow) return;
    const cowIdVal = document.getElementById('edit-cow-id').value.trim();
    const motherId = document.getElementById('edit-mother-id').value.trim();
    if (!cowIdVal && !motherId) { alert('å€‹ä½“è­˜åˆ¥ç•ªå·ã‹æ¯ç‰›ç•ªå·ã®ã©ã¡ã‚‰ã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
    
    cow.cowId = cowIdVal || null;
    cow.motherId = motherId;
    cow.fatherId = document.getElementById('edit-father-id').value.trim();
    cow.bmsId = document.getElementById('edit-bms-id').value.trim();
    cow.birthDate = document.getElementById('edit-birth-date').value;
    cow.gender = document.querySelector('input[name="edit-gender"]:checked').value;
    cow.castrationStatus = cow.gender === 'ã‚ªã‚¹' ? (cow.castrationStatus === 'å¯¾è±¡å¤–' ? 'æœªå‡¦ç†' : cow.castrationStatus) : 'å¯¾è±¡å¤–';
    const birthSizeRadio = document.querySelector('input[name="edit-birth-size"]:checked');
    cow.birthSize = birthSizeRadio ? birthSizeRadio.value : cow.birthSize;
    cow.birthMemo = document.getElementById('edit-birth-memo').value.trim();
    cow.name = cow.cowId || `${cow.motherId}ã®å­-${new Date(cow.birthDate).getMonth() + 1}/${new Date(cow.birthDate).getDate()}`;

    saveData();
    alert('æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
    document.getElementById('edit-cow-modal').style.display = 'none';
    renderCowDetail(cow.id);
}

function saveSaleMonth() {
    const cow = state.cows.find(c => c.id === state.currentCowId);
    if (!cow) return;
    const selectedMonth = document.getElementById('sale-month-select').value;
    cow.saleMonth = selectedMonth || null;
    saveData();
    alert('ã‚»ãƒªäºˆå®šæœˆã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
    renderCowDetail(cow.id);
    renderDashboard();
}

function handleDeleteCow() {
    const cow = state.cows.find(c => c.id === state.currentCowId);
    if (!cow) return;
    if (confirm(`ã€Œ${getCowDisplayName(cow)}ã€ã®æƒ…å ±ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
        state.cows = state.cows.filter(c => c.id !== cow.id);
        state.healthRecords = state.healthRecords.filter(r => r.cowId !== cow.id);
        state.vaccineEvents = state.vaccineEvents.filter(ve => ve.cowId !== cow.id);
        saveData();
        alert(`ã€Œ${getCowDisplayName(cow)}ã€ã®æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
        showPage('cow-list');
    }
}

function initializeHealthMatrixChanges(filter = null) {
    healthMatrixChanges = {};
    let cowsToInitialize = getActiveCows();
    if (filter === 'treating') { cowsToInitialize = cowsToInitialize.filter(cow => getCowHealthStatusObject(cow.id).status === 'æ²»ç™‚ä¸­'); }
    cowsToInitialize.forEach(cow => { healthMatrixChanges[cow.id] = getCowHealthStatusObject(cow.id); });
}

function renderHealthManagementList(filter = null) {
    const body = document.getElementById('health-list-body');
    const titleEl = document.getElementById('health-management-title');
    const sortBy = document.getElementById('sort-health-list').value;
    body.innerHTML = '';
    let cowsToShow = Object.keys(healthMatrixChanges).map(cowId => state.cows.find(c => c.id === cowId)).filter(Boolean);
    cowsToShow.forEach(cow => { const tempStatus = healthMatrixChanges[cow.id]; cow.currentStatus = tempStatus.status; cow.currentSymptom = tempStatus.symptom; cow.currentTemp = tempStatus.temperature; cow.currentMemo = tempStatus.memo; });
    const[sortKey,sortOrder]=sortBy.split('_');
    cowsToShow.sort((a,b)=>{let valA=(sortKey==='status')?a.currentStatus:a[sortKey];let valB=(sortKey==='status')?b.currentStatus:b[sortKey];if(sortKey==='birthDate'){valA=new Date(valA);valB=new Date(valB);}if(valA<valB)return sortOrder==='asc'?-1:1;if(valA>valB)return sortOrder==='asc'?1:-1;return 0;});
    titleEl.textContent = filter === 'treating' ? 'æ²»ç™‚ä¸­ã®ç‰›ä¸€è¦§' : 'å¥åº·ç®¡ç†ä¸€è¦§';
    cowsToShow.forEach(cow => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><span class="cow-name" onclick="showPage('cow-detail', {cowId: '${cow.id}'})">${getCowDisplayName(cow)}</span></td>
                        <td><select data-cow-id="${cow.id}" class="health-status-select"><option value="å¥åº·" ${cow.currentStatus === 'å¥åº·' ? 'selected' : ''}>å¥åº·</option><option value="æ²»ç™‚ä¸­" ${cow.currentStatus === 'æ²»ç™‚ä¸­' ? 'selected' : ''}>æ²»ç™‚ä¸­</option></select></td>
                        <td><select data-cow-id="${cow.id}" class="symptom-select" ${cow.currentStatus === 'å¥åº·' ? 'disabled' : ''}><option value="ãªã—">ãªã—</option><option value="ä¸‹ç—¢" ${cow.currentSymptom === 'ä¸‹ç—¢' ? 'selected' : ''}>ä¸‹ç—¢</option><option value="è‚ºç‚" ${cow.currentSymptom === 'è‚ºç‚' ? 'selected' : ''}>è‚ºç‚</option><option value="å’³" ${cow.currentSymptom === 'å’³' ? 'selected' : ''}>å’³</option><option value="é£Ÿæ¬²ä¸æŒ¯" ${cow.currentSymptom === 'é£Ÿæ¬²ä¸æŒ¯' ? 'selected' : ''}>é£Ÿæ¬²ä¸æŒ¯</option><option value="ç™ºç†±" ${cow.currentSymptom === 'ç™ºç†±' ? 'selected' : ''}>ç™ºç†±</option><option value="ãã®ä»–" ${cow.currentSymptom === 'ãã®ä»–' ? 'selected' : ''}>ãã®ä»–</option></select></td>
                        <td><input type="number" step="0.1" min="37.0" max="42.0" class="temp-input" data-cow-id="${cow.id}" value="${cow.currentTemp || ''}" placeholder="--.-"></td>
                        <td><input type="text" class="memo-input" data-cow-id="${cow.id}" value="${cow.currentMemo || ''}" placeholder="æŠ•è–¬ãªã©"></td>`;
        body.appendChild(tr);
    });
}

function handleHealthListChange(e) {
    const target = e.target;
    const cowId = target.dataset.cowId;
    if (!cowId) return;
    const tr = target.closest('tr');
    healthMatrixChanges[cowId] = healthMatrixChanges[cowId] || {};
    if (target.classList.contains('health-status-select')) {
        const statusSelect = tr.querySelector('.health-status-select');
        const symptomSelect = tr.querySelector('.symptom-select');
        healthMatrixChanges[cowId].status = statusSelect.value;
        if (statusSelect.value === 'å¥åº·') { symptomSelect.value = 'ãªã—'; symptomSelect.disabled = true; healthMatrixChanges[cowId].symptom = 'ãªã—'; } else { symptomSelect.disabled = false; }
    } else if (target.classList.contains('symptom-select')) {
        healthMatrixChanges[cowId].symptom = target.value;
    } else if (target.classList.contains('temp-input')) {
        healthMatrixChanges[cowId].temperature = target.value;
    } else if (target.classList.contains('memo-input')) {
        healthMatrixChanges[cowId].memo = target.value;
    }
}

function handleSaveHealthChanges() {
    let recordsAdded = 0;
    Object.keys(healthMatrixChanges).forEach(cowId => {
        const tempRecord = healthMatrixChanges[cowId];
        const lastSavedRecord = getCowHealthStatusObject(cowId);
        const hasChanged = tempRecord.status !== lastSavedRecord.status || tempRecord.symptom !== lastSavedRecord.symptom || tempRecord.temperature !== lastSavedRecord.temperature || tempRecord.memo !== lastSavedRecord.memo;
        if (hasChanged) {
            state.healthRecords.push({id: createId(), cowId: cowId, date: new Date().toISOString(), status: tempRecord.status, symptom: tempRecord.symptom, temperature: tempRecord.temperature, memo: tempRecord.memo });
            recordsAdded++;
        }
    });
    if (recordsAdded > 0) { saveData(); alert(`${recordsAdded}ä»¶ã®å¥åº·è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`); } else { alert('å¤‰æ›´ã•ã‚ŒãŸè¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'); }
    initializeHealthMatrixChanges();
    renderHealthManagementList();
}

function updateCastrationStatus(cowId) {
    const cow = state.cows.find(c => c.id === cowId);
    if(cow && confirm(`${getCowDisplayName(cow)}ã‚’å»å‹¢æ¸ˆã¿ã«ã—ã¾ã™ã‹ï¼Ÿ`)) { cow.castrationStatus = 'å‡¦ç†æ¸ˆ'; saveData(); renderCowDetail(cow.id); }
}

function revertCastrationStatus(cowId) {
    const cow = state.cows.find(c => c.id === cowId);
    if(cow && confirm(`${getCowDisplayName(cow)}ã‚’æœªå‡¦ç†ã®çŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ`)) { cow.castrationStatus = 'æœªå‡¦ç†'; saveData(); renderCowDetail(cow.id); }
}

// --- ä»¥ä¸‹ã€å¤‰æ›´ãŒå°‘ãªã„ã€ã¾ãŸã¯å¤‰æ›´ãŒãªã„é–¢æ•° ---
function renderCowList(filter=null){const listEl=document.getElementById('cow-list-items');const titleEl=document.getElementById('cow-list-title');listEl.innerHTML='';let cowsToShow=[];if(filter==='castration'){titleEl.textContent='å»å‹¢æ¨å¥¨æ—¥é½¢ã®ç‰›';cowsToShow=getActiveCows().filter(c=>c.gender==='ã‚ªã‚¹'&&c.castrationStatus==='æœªå‡¦ç†'&&getDaysOld(c.birthDate)>=state.settings.castrationDays);}else{titleEl.textContent='ç‰›ä¸€è¦§ï¼ˆé£¼è‚²ä¸­ï¼‰';cowsToShow=getActiveCows().sort((a,b)=>new Date(b.birthDate)-new Date(a.birthDate));}if(cowsToShow.length===0){listEl.innerHTML='<li class="list-item">å¯¾è±¡ã®ç‰›ã¯ã„ã¾ã›ã‚“ã€‚</li>';return;}cowsToShow.forEach(cow=>{const li=document.createElement('li');li.className='list-item clickable';li.onclick=()=>showPage('cow-detail',{cowId:cow.id});li.innerHTML=`<div><div class="list-item-content">${getCowDisplayName(cow)}</div><div class="list-item-subtext">${cow.gender}, ${getDaysOld(cow.birthDate)}æ—¥é½¢</div></div><span>></span>`;listEl.appendChild(li);});}
function renderShippedList(){const listEl=document.getElementById('shipped-list-items');listEl.innerHTML='';const shippedCows=getShippedCows().sort((a,b)=>new Date(b.saleInfo.date)-new Date(a.saleInfo.date));if(shippedCows.length===0){listEl.innerHTML='<li class="list-item">å‡ºè·æ¸ˆã¿ã®ç‰›ã¯ã„ã¾ã›ã‚“ã€‚</li>';return;}shippedCows.forEach(cow=>{const li=document.createElement('li');li.className='list-item clickable';li.onclick=()=>showPage('cow-detail',{cowId:cow.id});const buyerText=cow.saleInfo.buyerName?`, è³¼è²·è€…: ${cow.saleInfo.buyerName}`:'';li.innerHTML=`<div><div class="list-item-content">${getCowDisplayName(cow)}</div><div class="list-item-subtext">ä¾¡æ ¼: ${cow.saleInfo.price}åƒå††, ä½“é‡: ${cow.saleInfo.weight}kg${buyerText}</div></div><span>></span>`;listEl.appendChild(li);});}
function handleSaleInfoSubmit(e){e.preventDefault();const cow=state.cows.find(c=>c.id===state.currentCowId);if(!cow)return;cow.status='å‡ºè·æ¸ˆ';cow.saleInfo={daysOld:document.getElementById('sale-days-old').value,weight:document.getElementById('sale-weight').value,price:document.getElementById('sale-price').value,buyerName:document.getElementById('buyer-name').value};saveData();alert(`${getCowDisplayName(cow)}ã‚’å‡ºè·æ¸ˆã¨ã—ã¦ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã—ãŸã€‚`);document.getElementById('sale-info-modal').style.display='none';e.target.reset();showPage('cow-list');}
function renderVaccineMatrix(){const pendingTable=document.getElementById('vaccine-matrix-table-pending');const completedTable=document.getElementById('vaccine-matrix-table-completed');const completedCard=document.getElementById('vaccine-completed-card');pendingTable.innerHTML='';completedTable.innerHTML='';const vaccines=state.vaccineTypes;if(vaccines.length===0){pendingTable.innerHTML='<tr><td>è¨­å®šç”»é¢ã§ãƒ¯ã‚¯ãƒãƒ³ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</td></tr>';completedCard.style.display='none';return;}const pendingCows=[],completedCows=[];const requiredVaccineIds=new Set(vaccines.map(v=>v.id));getActiveCows().forEach(cow=>{const takenVaccineIds=new Set(state.vaccineEvents.filter(ve=>ve.cowId===cow.id).map(ve=>ve.vaccineTypeId));let isCompleted=true;requiredVaccineIds.forEach(reqId=>{if(!takenVaccineIds.has(reqId))isCompleted=false;});if(isCompleted)completedCows.push(cow);else pendingCows.push(cow);});let headerHtml=`<thead><tr><th>åå‰ (ä¸‹5æ¡)</th>`;vaccines.forEach(v=>{headerHtml+=`<th class="rotate-header">${v.name}</th>`;});headerHtml+='</tr></thead>';if(pendingCows.length>0){let bodyHtml='<tbody>';pendingCows.sort((a,b)=>new Date(b.birthDate)-new Date(a.birthDate)).forEach(cow=>{bodyHtml+=`<tr><td class="cow-name" onclick="showPage('cow-detail',{cowId:'${cow.id}'})">${getCowDisplayName(cow)}</td>`;vaccines.forEach(vaccine=>{const key=`${cow.id}-${vaccine.id}`;const isChecked=vaccineMatrixChanges[key]||false;bodyHtml+=`<td style="text-align:center;"><input type="checkbox" data-cow-id="${cow.id}" data-vaccine-id="${vaccine.id}" ${isChecked?'checked':''}></td>`;});bodyHtml+='</tr>';});bodyHtml+='</tbody>';pendingTable.innerHTML=headerHtml+bodyHtml;}else{pendingTable.innerHTML='<tr><td>æ¥ç¨®ãŒå¿…è¦ãªç‰›ã¯ã„ã¾ã›ã‚“ã€‚</td></tr>';}if(completedCows.length>0){completedCard.style.display='block';let bodyHtml='<tbody>';completedCows.sort((a,b)=>new Date(b.birthDate)-new Date(a.birthDate)).forEach(cow=>{bodyHtml+=`<tr><td class="cow-name" onclick="showPage('cow-detail',{cowId:'${cow.id}'})">${getCowDisplayName(cow)}</td>`;vaccines.forEach(()=>{bodyHtml+=`<td style="text-align:center;"><input type="checkbox" checked disabled></td>`;});bodyHtml+='</tr>';});bodyHtml+='</tbody>';completedTable.innerHTML=headerHtml+bodyHtml;}else{completedCard.style.display='none';}}
function handleAddVaccineType(e){e.preventDefault();const name=document.getElementById('new-vaccine-name').value;const minDays=parseInt(document.getElementById('new-vaccine-min-days').value);const maxDays=parseInt(document.getElementById('new-vaccine-max-days').value);if(!name||!minDays||!maxDays){alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');return;}state.vaccineTypes.push({id:createId(),name,minDays,maxDays});saveData();renderSettingsPage();e.target.reset();}
function renderSettingsPage(){const list=document.getElementById('vaccine-settings-list');list.innerHTML='';state.vaccineTypes.forEach(vt=>{const rangeText=(vt.minDays&&vt.maxDays)?`(${vt.minDays}ï½${vt.maxDays}æ—¥é½¢)`:'(æ—¥é½¢æœªè¨­å®š)';list.innerHTML+=`<div class="list-item">${vt.name} ${rangeText} <button class="button-small" onclick="deleteVaccineType('${vt.id}')">å‰Šé™¤</button></div>`;});document.getElementById('castration-days').value=state.settings.castrationDays;}
function initializeVaccineMatrixChanges(){vaccineMatrixChanges={};state.vaccineEvents.forEach(ve=>{const key=`${ve.cowId}-${ve.vaccineTypeId}`;vaccineMatrixChanges[key]=true;});}
function handleVaccineMatrixChange(e){if(!e.target.matches('#vaccine-matrix-table-pending input[type="checkbox"]'))return;const cowId=e.target.dataset.cowId;const vaccineId=e.target.dataset.vaccineId;const isChecked=e.target.checked;const key=`${cowId}-${vaccineId}`;if(isChecked){vaccineMatrixChanges[key]=true;}else{delete vaccineMatrixChanges[key];}}
function handleSaveVaccineChanges(){const newVaccineEvents=[];for(const key in vaccineMatrixChanges){const[cowId,vaccineTypeId]=key.split('-');const existingEvent=state.vaccineEvents.find(ve=>ve.cowId===cowId&&ve.vaccineTypeId===vaccineTypeId);if(existingEvent){newVaccineEvents.push(existingEvent);}else{newVaccineEvents.push({id:createId(),cowId:cowId,vaccineTypeId:vaccineTypeId,status:'å®Œäº†',date:new Date().toISOString()});}}state.vaccineEvents=newVaccineEvents;saveData();alert('ãƒ¯ã‚¯ãƒãƒ³æ¥ç¨®çŠ¶æ³ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');renderVaccineMatrix();}
function deleteVaccineType(vtId){if(confirm('ã“ã®ãƒ¯ã‚¯ãƒãƒ³è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿé–¢é€£ã™ã‚‹æ¥ç¨®å±¥æ­´ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ã€‚')){state.vaccineTypes=state.vaccineTypes.filter(vt=>vt.id!==vtId);saveData();renderSettingsPage();}}
function handleSaveSettings(){state.settings.castrationDays=parseInt(document.getElementById('castration-days').value)||90;saveData();alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');}
function exportData(){const dataStr=JSON.stringify(state,null,2);const blob=new Blob([dataStr],{type:"application/json"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=`ushikanri_backup_${new Date().toISOString().split('T')[0]}.json`;a.click();URL.revokeObjectURL(url);}
function importData(event){const file=event.target.files[0];if(!file)return;if(!confirm("ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ"))return;const reader=new FileReader();reader.onload=function(e){try{const importedState=JSON.parse(e.target.result);state=importedState;saveData();alert("ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚");showPage('dashboard');}catch(error){alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æœ‰åŠ¹ãªJSONãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");}};reader.readAsText(file);}

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').then(registration => {
      console.log('ServiceWorkerã®ç™»éŒ²ã«æˆåŠŸã—ã¾ã—ãŸ: ', registration.scope);
    }).catch(err => {
      console.log('ServiceWorkerã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ', err);
    });
  });
}
</script>
</body>
</html>